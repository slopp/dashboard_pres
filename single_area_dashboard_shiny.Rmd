---
title: Current Conditions
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: journal
    css: styles_dashboard.css
runtime: shiny
---

```{r setup}
library(ggplot2)
source("utils.R")
library(jsonlite)
library(flexdashboard)
library(shiny)
opts <- getKnownAreas()
resorts <- opts$resorts
```

Sidebar {.sidebar}
--------------------
```{r}
areas <- reactiveFileReader(5000, session = NULL, filePath = "area.rds", readFunc = readRDS)
weather <- reactive({
  invalidateLater(60000, session = NULL)
  w <- lapply(resorts, getCurrentWeather)
  Sys.sleep(0.1)
  w
})

selectInput("resort", "", choices = resorts, selected = "Abasin")


curArea <- reactive({
  ind <- which(resorts==input$resort)
  areas()[[ind]]
})

areaWeather <- reactive({
  ind <- which(resorts==input$resort)
  weather()[[ind]]
})

renderUI({tags$img(src=curArea()$logo)})
```



Summary {data-height=30}
----------


### Last 48 Hours {data-width=30}
```{r}
renderValueBox({
valueBox(caption = curArea()$secondarySurfaceCondition,
                 
         value = paste0(curArea()$snowLast48Hours,'"'),
         icon="ion-ios-snowy")
})
```

### Base {data-width=30}

```{r} 
renderValueBox({
valueBox(value=paste0(curArea()$avgBaseDepthMax, '"'), caption = "Base", color="warning", icon="fa-map-signs")
})
```

### Weather {data-width=30}

```{r} 
renderValueBox({
weather_icon <- mapDescIcon(areaWeather()$weather)
valueBox(caption=areaWeather()$weather, value =  areaWeather()$feelslike_string, icon=weather_icon, color="primary")
})
```


Charts {data-height=70}
------------

### Snow Forecast
```{r}
renderPlot({
f <- data.frame(
    label=c("24 Hours", "48 Hours","72 Hours"),
    value = c(curArea()$predictedSnowFall_24Hours,
              curArea()$predictedSnowFall_48Hours,
              curArea()$predictedSnowFall_72Hours),
    stringsAsFactors = FALSE
  )
f$value <- as.numeric(f$value)
ggplot(data=f) + geom_bar(aes(x=factor(1:3), y=value), stat="identity", fill = "#f4a34b") +
  scale_x_discrete(labels=f$label, breaks=1:3) +
  scale_y_continuous(limits=c(0, max(f$value))) + 
  xlab("") +
  ylab("")+
  theme_minimal() 
})
```

### Runs

```{r}
d <- reactive({
  tmp <- data.frame(
    cur = as.numeric(c(curArea()$openDownHillTrails,
                     curArea()$openDownHillLifts)),
    max = as.numeric(c(curArea()$maxOpenDownHillTrails,
                     curArea()$maxOpenDownHillLifts)),
    labels = c("Trails", "Lifts"),
    stringsAsFactors = FALSE
  )
  tmp$percent <- round((tmp$cur / tmp$max)*100, digits=0)
  tmp
})

# Trails
renderGauge({
  p <- d()$percent[1]
  createPercentGauge(p,"Trails Open")
  })

# Lifts 
renderGauge({
  p <- d()$percent[2]
  createPercentGauge(p,"Lifts Open")
  })

```


Acknowledgement {data-height=2}
------------
![](sclogo.png) ![](wulogo.jpg) ![](rslogo.png) <br>
Data Courtesy of Snocountry and Weather Underground. Report by RStudio. <br>
Not to be used for commercial purposes.

###
```{r}
renderText({
  curArea()
  areaWeather()
  paste0("Last Updated on: ",Sys.Date(), " at ", format(Sys.time(), '%r'))
})
```

